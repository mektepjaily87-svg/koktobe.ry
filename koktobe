from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes, MessageHandler, filters
import openpyxl
from openpyxl import Workbook
from collections import defaultdict
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.base import MIMEBase
from email.mime.text import MIMEText
from email import encoders

# ---------------- –¢–æ–∫–µ–Ω ----------------
TOKEN = "7873238404:AAELnBRLypysbmd6uqgIXZWdgwKTrWS7pSo"

# ---------------- –°–∞—É–∞–ª–Ω–∞–º–∞ —Å“±—Ä–∞“õ—Ç–∞—Ä—ã ----------------
questions = {
    "parent": [
        "1. –ú–µ–Ω—ñ“£ –±–∞–ª–∞–º –º–µ–∫—Ç–µ–ø–∫–µ “õ—É–∞–Ω–∞ –±–∞—Ä–∞–¥—ã",
        "2. –°—ã–Ω—ã–ø—Ç–∞ “õ–æ–ª–∞–π–ª—ã –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ –±–∞—Ä",
        "3. –ú–µ–∫—Ç–µ–ø —Å–∞–ø–∞–ª—ã –±—ñ–ª—ñ–º –±–µ—Ä–µ–¥—ñ",
        "4. –û“õ—É –ø”ô–Ω–¥–µ—Ä—ñ –º–µ–Ω—ñ“£ –±–∞–ª–∞–º–∞ –æ“£–∞–π –±–µ—Ä—ñ–ª–µ–¥—ñ",
        "5. –ú“±“ì–∞–ª—ñ–º–¥–µ—Ä –±—ñ–∑–¥—ñ“£ –±–∞–ª–∞–Ω—ã“£ –æ“õ—É–¥–∞“ì—ã –∂–µ—Ç—ñ—Å—Ç—ñ–∫—Ç–µ—Ä—ñ–Ω ”ô–¥—ñ–ª –±–∞“ì–∞–ª–∞–π–¥—ã",
        "6. –ë—ñ–∑–¥—ñ“£ –±–∞–ª–∞–º—ã–∑ –æ“õ—É —Å–∞–±–∞“õ—Ç–∞—Ä—ã –º–µ–Ω “Ø–π —Ç–∞–ø—Å—ã—Ä–º–∞–ª–∞—Ä—ã–Ω–∞ —à–∞–º–∞–¥–∞–Ω —Ç—ã—Å –∂“Ø–∫—Ç–µ–ª–º–µ–π–¥—ñ",
        "7. –ú–µ–∫—Ç–µ–ø—Ç–µ “õ–æ–ª–¥–∞–Ω—ã–ª–∞—Ç—ã–Ω –æ“õ—ã—Ç—É–¥—ã“£ –∂–∞“£–∞ —Ç”ô—Å—ñ–ª–¥–µ—Ä—ñ –±—ñ–∑–¥—ñ“£ –±–∞–ª–∞–º—ã–∑–¥—ã“£ “õ–∞–±—ñ–ª–µ—Ç—Ç–µ—Ä—ñ–Ω—ñ“£ –∫”©—Ä—ñ–Ω—ñ—Å—ñ –º–µ–Ω –¥–∞–º—É—ã–Ω–∞ –∂–∞“ì–¥–∞–π –∂–∞—Å–∞–π–¥—ã",
        "8. –ú–µ–Ω –±–∞–ª–∞–Ω—ã“£ –æ“õ—É –∂–µ—Ç—ñ—Å—Ç—ñ–∫—Ç–µ—Ä—ñ –º–µ–Ω –º—ñ–Ω–µ–∑-“õ“±–ª“õ—ã —Ç—É—Ä–∞–ª—ã –∞“õ–ø–∞—Ä–∞—Ç—Ç–∞–Ω–¥—ã—Ä—É —Å–∞–ø–∞—Å—ã–Ω–∞ “õ–∞–Ω–∞“ì–∞—Ç—Ç–∞–Ω–∞–º—ã–Ω",
        "9. –ú–µ–Ω –º–µ–∫—Ç–µ–ø—Ç–µ–≥—ñ —Å–∞–±–∞“õ—Ç–∞–Ω —Ç—ã—Å –∂“±–º—ã—Å –±–∞“ì–¥–∞—Ä–ª–∞–º–∞—Å—ã–Ω–∞ —Ä–∏–∑–∞–º—ã–Ω",
        "10. –ú–µ–Ω –±–∞–ª–∞–º–Ω—ã“£ —Å—ã–Ω—ã–ø –∂–µ—Ç–µ–∫—à—ñ—Å—ñ–Ω—ñ“£ –∂“±–º—ã—Å—ã–Ω–∞ “õ–∞–Ω–∞“ì–∞—Ç—Ç–∞–Ω–∞–º—ã–Ω",
        "11. –ú–µ–∫—Ç–µ–ø—Ç–µ –±—ñ–∑–¥—ñ“£ –±–∞–ª–∞–º—ã–∑ “Ø—à—ñ–Ω –ø–∞–π–¥–∞–ª—ã –∂”ô–Ω–µ “õ—ã–∑—ã“õ—Ç—ã —ñ—Å-—à–∞—Ä–∞–ª–∞—Ä ”©—Ç–∫—ñ–∑—ñ–ª–µ–¥—ñ",
        "12. –ú–µ–Ω –º–µ–∫—Ç–µ–ø –∞—Å—Ö–∞–Ω–∞—Å—ã/–±—É—Ñ–µ—Ç –∂“±–º—ã—Å—ã–º–µ–Ω “õ–∞–Ω–∞“ì–∞—Ç—Ç–∞–Ω–∞–º—ã–Ω",
        "13. –ü–µ–¥–∞–≥–æ–≥—Ç–∞—Ä –ø–µ–¥–∞–≥–æ–≥–∏–∫–∞–ª—ã“õ —ç—Ç–∏–∫–∞ –Ω–æ—Ä–º–∞–ª–∞—Ä—ã–Ω —Å–∞“õ—Ç–∞–π–¥—ã",
        "14. –ú–µ–Ω—ñ“£ –±–∞–ª–∞–º –º–µ–∫—Ç–µ–ø—Ç–µ “õ–∞—É—ñ–ø—Å—ñ–∑",
        "15. –ú–µ–∫—Ç–µ–ø—Ç–µ –æ–ª–∞—Ä –±—ñ–∑–¥—ñ“£ –±–∞–ª–∞–º—ã–∑–¥—ã“£ –¥–µ–Ω—Å–∞—É–ª—ã“ì—ã–Ω–∞ “õ–∞–º“õ–æ—Ä–ª—ã“õ –∂–∞—Å–∞–π–¥—ã",
        "16. –ú–µ–Ω –º–µ–∫—Ç–µ–ø ”ô–∫—ñ–º—à—ñ–ª—ñ–≥—ñ–Ω—ñ“£ –∂“±–º—ã—Å—ã–Ω–∞ “õ–∞–Ω–∞“ì–∞—Ç—Ç–∞–Ω–∞–º—ã–Ω",
        "17. –ú–µ–∫—Ç–µ–ø ”©–º—ñ—Ä—ñ–Ω–µ “õ–∞—Ç—ã—Å—É“ì–∞ –Ω–∏–µ—Ç –±–∞—Ä",
    ],
    "student": [
        "1. –ú–µ–Ω ”©–∑ –º–µ–∫—Ç–µ–±—ñ–º–¥–µ –æ“õ—É“ì–∞ “õ—ã–∑—ã“ì–∞–º—ã–Ω",
        "2. –ú–µ–Ω—ñ“£ —Å“Ø–π—ñ–∫—Ç—ñ –ø”ô–Ω–¥–µ—Ä—ñ–º –±–∞—Ä (–µ–≥–µ—Ä —Å–æ–ª–∞–π –±–æ–ª—Å–∞, “õ–∞–π—Å—ã—Å—ã?)",
        "3. –ú–µ–Ω—ñ“£ —Å“Ø–π—ñ–∫—Ç—ñ –º“±“ì–∞–ª—ñ–º–¥–µ—Ä—ñ–º –±–∞—Ä",
        "4. –ë—ñ–∑–¥—ñ“£ –º–µ–∫—Ç–µ–ø –º“±“ì–∞–ª—ñ–º–¥–µ—Ä—ñ–Ω–µ “õ–∏—ã–Ω –∂–∞“ì–¥–∞–π–¥–∞ –∫–µ“£–µ—Å –ø–µ–Ω –∫”©–º–µ–∫ —Å“±—Ä–∞—É“ì–∞ –±–æ–ª–∞–¥—ã",
        "5. –°–∞–±–∞“õ—Ç–∞ –º–µ–Ω ”ô—Ä“õ–∞—à–∞–Ω ”©–∑ –ø—ñ–∫—ñ—Ä—ñ–º–¥—ñ –µ—Ä–∫—ñ–Ω –∞–π—Ç–∞ –∞–ª–∞–º—ã–Ω",
        "6. –°–∞–±–∞“õ—Ç–∞ –º“±“ì–∞–ª—ñ–º –º–µ–Ω—ñ“£ –º—ñ–Ω–µ–∑-“õ“±–ª“õ—ã–º–¥—ã –µ–º–µ—Å, –º–µ–Ω—ñ“£ –±—ñ–ª—ñ–º—ñ–º–¥—ñ –±–∞“ì–∞–ª–∞–π–¥—ã",
        "7. –ú–µ–Ω –º–µ–∫—Ç–µ–ø—Ç–µ –∂–∏—ñ —à–∞—Ä—à–∞–π–º—ã–Ω",
        "8. –ú–µ–Ω—ñ“£ –º–µ–∫—Ç–µ–±—ñ–º–¥–µ –¥–µ—Ä–±–µ—Å –∂”ô–Ω–µ –∂–∏—ã–Ω—Ç—ã“õ –∂“±–º—ã—Å—Ç–∞—Ä–¥—ã“£ —Å–∞–Ω—ã –±—ñ—Ä –∫“Ø–Ω–¥–µ –µ–∫—ñ–¥–µ–Ω –∫”©–ø",
        "9. –ú–µ–Ω –º–µ–∫—Ç–µ–ø—Ç–µ ”©–∑—ñ–º–¥—ñ “õ–∞—É—ñ–ø—Å—ñ–∑ —Å–µ–∑—ñ–Ω–µ–º—ñ–Ω, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—è–ª—ã“õ —Ç“±—Ä“ì—ã–¥–∞–Ω —ã“£“ì–∞–π–ª—ã",
        "10. –ú–µ–Ω —Ç–∞–º–∞“õ—Ç–∞–Ω—É —Å–∞–ø–∞—Å—ã–Ω–∞ “õ–∞–Ω–∞“ì–∞—Ç—Ç–∞–Ω–∞–º—ã–Ω",
        "11. –ú–µ–Ω ”©–∑ “õ“±“õ—ã“ì—ã–º–¥—ã –±—ñ–ª–µ–º—ñ–Ω",
        "12. –ú–µ–Ω –∫–µ–ª–µ—Å—ñ “Ø–π—ñ—Ä–º–µ–ª–µ—Ä–≥–µ, —Å–µ–∫—Ü–∏—è–ª–∞—Ä“ì–∞, –∞–Ω—Å–∞–º–±–ª—å–¥–µ—Ä–≥–µ –±–∞—Ä–∞–º—ã–Ω",
        "13. –ú–µ–Ω–¥–µ –º–µ–∫—Ç–µ–ø —ñ—Å—Ç–µ—Ä—ñ–Ω–µ “õ–∞—Ç—ã—Å—É“ì–∞ –¥–µ–≥–µ–Ω “±–º—Ç—ã–ª—ã—Å –ø–µ–Ω “õ–∞–∂–µ—Ç—Ç—ñ–ª—ñ–∫ –±–∞—Ä",
        "14. –ú–µ–Ω—ñ“£ –º–µ–∫—Ç–µ–±—ñ–º–¥–µ –æ–ª “Ø—à—ñ–Ω –ø–∞–π–¥–∞–ª—ã –∂”ô–Ω–µ –º–∞“£—ã–∑–¥—ã –Ω”ô—Ä—Å–µ –∂–∞—Å–∞“ì–∞–Ω –∫–µ–∑–¥–µ –º–µ–Ω—ñ“£ –∂–µ—Ç—ñ—Å—Ç—ñ–∫—Ç–µ—Ä—ñ–º –±–∞–π“õ–∞–ª–∞–¥—ã",
        "15. –ú–µ–Ω ”©–∑ –º–µ–∫—Ç–µ–±—ñ–º–¥—ñ –∂–∞“õ—Å—ã –∫”©—Ä–µ–º—ñ–Ω –∂”ô–Ω–µ –æ–Ω–¥–∞ –æ“õ—ã“ì–∞–Ω—ã–º–¥—ã –º–∞“õ—Ç–∞–Ω —Ç“±—Ç–∞–º—ã–Ω",
    ],
    "teacher": [
        "1. –ú–µ–Ω –æ—Å—ã –º–µ–∫—Ç–µ–ø—Ç–µ –∂“±–º—ã—Å —ñ—Å—Ç–µ–≥–µ–Ω—ñ–º–¥—ñ –º–∞“õ—Ç–∞–Ω —Ç“±—Ç–∞–º—ã–Ω",
        "2. –ú–µ–Ω —Ç–∏—ñ–º–¥—ñ ”ô–¥—ñ—Å—Ç–µ–º–µ–ª—ñ–∫ –∫”©–º–µ–∫ –∞–ª–∞–º—ã–Ω",
        "3. –ú–µ–Ω –µ“£–±–µ–∫ –∂–∞“ì–¥–∞–π—ã–Ω–∞ “õ–∞–Ω–∞“ì–∞—Ç—Ç–∞–Ω–∞–º—ã–Ω",
        "4. –ú–µ–Ω –º–µ–∫—Ç–µ–ø ”ô–∫—ñ–º—à—ñ–ª—ñ–≥—ñ–Ω—ñ“£ –∂“±–º—ã—Å —Å—Ç–∏–ª—ñ–Ω–µ “õ–∞–Ω–∞“ì–∞—Ç—Ç–∞–Ω–∞–º—ã–Ω",
        "5. –ú–µ–∫—Ç–µ–ø –æ“õ—É—à—ã–ª–∞—Ä –∞—Ä–∞—Å—ã–Ω–¥–∞“ì—ã –∂–∞–Ω–∂–∞–ª–¥–∞—Ä–¥—ã —Ç–æ“õ—Ç–∞—Ç–∞–¥—ã –∂”ô–Ω–µ —Ç–∏—ñ–º–¥—ñ —à–µ—à–µ–¥—ñ",
        "6. –ú–µ–Ω –º–µ–∫—Ç–µ–ø—Ç—ñ“£ –æ“õ—É-–º–∞—Ç–µ—Ä–∏–∞–ª–¥—ã“õ –±–∞–∑–∞—Å—ã–Ω–∞ “õ–∞–Ω–∞“ì–∞—Ç—Ç–∞–Ω–∞–º—ã–Ω",
        "7. “∞–∂—ã–º–¥–∞ “õ–æ–ª–∞–π–ª—ã –º–æ—Ä–∞–ª—å–¥—ã“õ-–ø—Å–∏—Ö–æ–ª–æ–≥–∏—è–ª—ã“õ –∞—Ö—É–∞–ª –±–∞—Ä",
        "8. –ú–µ–Ω –º–µ–∫—Ç–µ–ø—Ç–µ–≥—ñ —Ç–∞–º–∞“õ—Ç–∞–Ω—É —Å–∞–ø–∞—Å—ã–Ω–∞ “õ–∞–Ω–∞“ì–∞—Ç—Ç–∞–Ω–∞–º—ã–Ω",
        "9. ”ò—Ä—ñ–ø—Ç–µ—Å—Ç–µ—Ä –º–∞“ì–∞–Ω –∫”©–º–µ–∫—Ç–µ—Å—É–≥–µ ”ô—Ä“õ–∞—à–∞–Ω –¥–∞–π—ã–Ω",
        "10. –û“õ—É —Å–∞–±–∞“õ—Ç–∞—Ä—ã–Ω —Å”ô—Ç—Ç—ñ ”©—Ç–∫—ñ–∑—É “Ø—à—ñ–Ω –º–µ–∫—Ç–µ–ø –±–∞—Ä–ª—ã“õ “õ–∞–∂–µ—Ç—Ç—ñ –æ“õ—É-”ô–¥—ñ—Å—Ç–µ–º–µ–ª—ñ–∫ –∂”ô–Ω–µ —Ç–µ—Ö–Ω–∏–∫–∞–ª—ã“õ “õ“±—Ä–∞–ª–¥–∞—Ä–¥—ã “±—Å—ã–Ω–¥—ã",
        "11. –ú–µ–∫—Ç–µ–ø—Ç–µ –º–µ–Ω—ñ“£ –∫”ô—Å—ñ–±–∏ –∂”ô–Ω–µ —à—ã“ì–∞—Ä–º–∞—à—ã–ª—ã“õ ”©—Å—É—ñ–º “Ø—à—ñ–Ω –∂–∞“ì–¥–∞–π –∂–∞—Å–∞–ª“ì–∞–Ω",
        "12. –ú–µ–∫—Ç–µ–ø—Ç–µ –ø–µ–¥–∞–≥–æ–≥—Ç–∞—Ä–¥—ã –∫”©—Ç–µ—Ä–º–µ–ª–µ—É ”ô–¥—ñ—Å—Ç–µ—Ä—ñ –±–µ–ª–≥—ñ–ª–µ–Ω–≥–µ–Ω",
        "13. –ú–µ–Ω –∂“±–º—ã—Å —ñ—Å—Ç–µ–π—Ç—ñ–Ω –±–∞–ª–∞–ª–∞—Ä –±—ñ–ª—ñ–º–≥–µ “±–º—Ç—ã–ª–∞–¥—ã",
        "14. –ú–µ–Ω –æ“õ—É—à—ã–ª–∞—Ä–º–µ–Ω “õ–∞—Ä—ã–º-“õ–∞—Ç—ã–Ω–∞—Å—ã–º–∞ “õ–∞–Ω–∞“ì–∞—Ç—Ç–∞–Ω–∞–º—ã–Ω",
        "15. –ú–µ–Ω —Å—ã–Ω—ã–ø –∂–µ—Ç–µ–∫—à—ñ—Å—ñ —Ä–µ—Ç—ñ–Ω–¥–µ–≥—ñ –∂“±–º—ã—Å—ã–º–∞ “õ–∞–Ω–∞“ì–∞—Ç—Ç–∞–Ω–∞–º—ã–Ω",
    ]
}

answers = ["–¢–æ–ª—ã“õ –∫–µ–ª—ñ—Å–µ–º—ñ–Ω", "–ö–µ–ª—ñ—Å–µ–º—ñ–Ω", "–ö–µ–ª—ñ—Å–ø–µ–π–º—ñ–Ω", "–¢–æ–ª—ã“õ –∫–µ–ª—ñ—Å–ø–µ–π–º—ñ–Ω", "–ë–∞—Å“õ–∞"]

all_results = defaultdict(list)

# ---------------- Excel-–≥–µ –∂–∞–∑—É ----------------
# ---------------- Excel-–≥–µ –∂–∞–∑—É ----------------
def save_to_excel(filename="survey_results.xlsx"):
    wb = Workbook()
    ws = wb.active
    ws.title = "Survey Results"

    # 1-–ø–∞—Ä–∞“õ: –∂–µ–∫–µ –∂–∞—É–∞–ø—Ç–∞—Ä
    ws.append(["User ID", "–†”©–ª", "–°“±—Ä–∞“õ", "–ñ–∞—É–∞–ø"])
    for user_id, records in all_results.items():
        for role, q, a in records:
            ws.append([user_id, role, q, a])

    # 2-–ø–∞—Ä–∞“õ: —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (”ô—Ä –∂–∞—É–∞–ø—Ç—ã“£ –ø–∞–π—ã–∑—ã –±”©–ª–µ–∫)
    ws_stats = wb.create_sheet("Statistics")

    # –ë–∞“ì–∞–Ω –∞—Ç—Ç–∞—Ä—ã
    header = ["–†”©–ª", "–°“±—Ä–∞“õ"]
    for ans in answers:
        header.append(f"{ans} (—Å–∞–Ω—ã)")
        header.append(f"{ans} (%)")
    ws_stats.append(header)

    stats = defaultdict(lambda: defaultdict(lambda: defaultdict(int)))
    total_counts = defaultdict(lambda: defaultdict(int))

    # –ñ–∞—É–∞–ø—Ç–∞—Ä–¥—ã —Å–∞–Ω–∞—É
    for user_id, records in all_results.items():
        for role, q, a in records:
            stats[role][q][a] += 1
            total_counts[role][q] += 1

    # ”ò—Ä –∂–∞—É–∞–ø—Ç—ã“£ ”©–∑ –ø–∞–π—ã–∑—ã–Ω –µ—Å–µ–ø—Ç–µ—É
    for role, qs in stats.items():
        for q, answers_dict in qs.items():
            total = total_counts[role][q]
            row = [role, q]

            for ans in answers:
                count = answers_dict.get(ans, 0)
                if total > 0:
                    percent = (count / total) * 100
                else:
                    percent = 0
                row.append(count)               # —Å–∞–Ω—ã
                row.append(f"{percent:.2f}%")   # —Ç–µ–∫ –æ—Å—ã –∂–∞—É–∞–ø—Ç—ã“£ –ø–∞–π—ã–∑—ã

            ws_stats.append(row)

    wb.save(filename)
    return filename



# ---------------- Email –∂—ñ–±–µ—Ä—É ----------------
def send_email_with_attachment(receiver_email, subject, body, filename):
    sender_email = "125aktobe125@gmail.com"
    sender_password = "rvrkygnxnglgwiix"  # Gmail App Password!

    msg = MIMEMultipart()
    msg["From"] = sender_email
    msg["To"] = receiver_email
    msg["Subject"] = subject
    msg.attach(MIMEText(body, "plain"))

    with open(filename, "rb") as attachment:
        part = MIMEBase("application", "octet-stream")
        part.set_payload(attachment.read())
        encoders.encode_base64(part)
        part.add_header("Content-Disposition", f"attachment; filename= {filename}")
        msg.attach(part)

    with smtplib.SMTP_SSL("smtp.gmail.com", 465) as server:
        server.login(sender_email, sender_password)
        server.send_message(msg)

# ---------------- Telegram –ª–æ–≥–∏–∫–∞—Å—ã ----------------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("–û“õ—É—à—ã", callback_data="role_student")],
        [InlineKeyboardButton("–ê—Ç–∞-–∞–Ω–∞", callback_data="role_parent")],
        [InlineKeyboardButton("–û“õ—ã—Ç—É—à—ã", callback_data="role_teacher")],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text("N.Nysanbaiuly –º–µ–∫—Ç–µ–±—ñ–Ω—ñ“£ —Å–∞—É–∞–ª–Ω–∞–º–∞—Å—ã–Ω–∞ “õ–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑! ”®–∑ —Ä”©–ª—ñ“£—ñ–∑–¥—ñ —Ç–∞“£–¥–∞“£—ã–∑:", reply_markup=reply_markup)

async def button(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    if query.data.startswith("role_"):
        role = query.data.split("_")[1]
        context.user_data["role"] = role
        context.user_data["q_index"] = 0
        context.user_data["answers"] = []
        await send_question(query, context)

    elif query.data.startswith("ans_"):
        _, choice = query.data.split("_", 1)
        role = context.user_data["role"]
        q_index = context.user_data["q_index"]

        if choice == "–ë–∞—Å“õ–∞":
            context.user_data["awaiting_custom_answer"] = True
            await query.message.reply_text("”®–∑ –∂–∞—É–∞–±—ã“£—ã–∑–¥—ã –∂–∞–∑—ã“£—ã–∑:")
        else:
            q = questions[role][q_index]
            context.user_data["answers"].append((role, q, choice))
            await next_question(query, context)

async def custom_answer(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if context.user_data.get("awaiting_custom_answer"):
        role = context.user_data["role"]
        q_index = context.user_data["q_index"]
        answer_text = update.message.text

        q = questions[role][q_index]
        context.user_data["answers"].append((role, q, answer_text))
        context.user_data["awaiting_custom_answer"] = False

        await next_question(update, context, from_message=True)

async def next_question(source, context, from_message=False):
    role = context.user_data["role"]
    context.user_data["q_index"] += 1
    q_index = context.user_data["q_index"]

    if q_index < len(questions[role]):
        question = questions[role][q_index]
        keyboard = [[InlineKeyboardButton(a, callback_data=f"ans_{a}")] for a in answers]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await source.message.reply_text(question, reply_markup=reply_markup)
    else:
        user_id = source.from_user.id if not from_message else source.message.from_user.id
        for role, q, a in context.user_data["answers"]:
            all_results[user_id].append((role, q, a))

        file = save_to_excel()

        # Email –∂—ñ–±–µ—Ä—É
        send_email_with_attachment("125aktobe125@gmail.com", "–°–∞—É–∞–ª–Ω–∞–º–∞ –Ω”ô—Ç–∏–∂–µ–ª–µ—Ä—ñ", "–°–∞—É–∞–ª–Ω–∞–º–∞ –∂–∞—É–∞–ø—Ç–∞—Ä—ã Excel —Ñ–∞–π–ª—ã–Ω–¥–∞.", file)

        await source.message.reply_text("‚úÖ –°–∞—É–∞–ª–Ω–∞–º–∞ –∞—è“õ—Ç–∞–ª–¥—ã! ")

async def send_question(query, context):
    role = context.user_data["role"]
    q_index = context.user_data["q_index"]
    question = questions[role][q_index]

    keyboard = [[InlineKeyboardButton(a, callback_data=f"ans_{a}")] for a in answers]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.message.reply_text(question, reply_markup=reply_markup)

# ---------------- –ó–∞–ø—É—Å–∫ ----------------
import asyncio

def main():
    app = Application.builder().token(TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(button))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, custom_answer))

    print("ü§ñ –ë–æ—Ç —ñ—Å–∫–µ “õ–æ—Å—ã–ª–¥—ã... Telegram-–¥–∞ /start –¥–µ–ø –∫”©—Ä—ñ“£—ñ–∑.")
    asyncio.run(app.run_polling())

